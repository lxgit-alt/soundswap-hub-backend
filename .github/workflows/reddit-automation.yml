name: Reddit Automation Engine
on:
  schedule:
   schedule:
    # Run every 2 minutes during ACTIVE EST hours (8 AM - 10 PM America/New_York)
    # UTC conversion: 13:00-03:00 (next day)
    - cron: '*/2 13-23 * * *'  # 13:00-23:59 UTC = 8:00-18:59 EST
    - cron: '*/2 0-3 * * *'    # 00:00-03:00 UTC = 19:00-22:00 EST
  workflow_dispatch:
    inputs:
      debug:
        description: 'Run in debug mode'
        required: false
        default: 'false'

jobs:
  run-reddit-automation:
    runs-on: ubuntu-latest
    name: Run Reddit Automation
    steps:
      - name: Checkout code (not needed but good practice)
        uses: actions/checkout@v4

      - name: Run Reddit Cron
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "üïí Running Reddit Automation at $(date)"
          echo "üåê Target: $VERCEL_URL"
          
          # Make the POST request to trigger the cron
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$VERCEL_URL/api/reddit-admin/cron")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n1)
          
          echo "üì° Response HTTP Code: $http_code"
          echo "üì¶ Response Body: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Cron executed successfully"
          else
            echo "‚ùå Cron execution failed with HTTP $http_code"
            exit 1
          fi

      - name: Check Cron Status
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "üìä Checking cron status..."
          curl -s "$VERCEL_URL/api/reddit-admin/cron-status"